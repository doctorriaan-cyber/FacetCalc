<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Block Mixture Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              'bkg-light': '#f7fafc',
              'bkg-dark': '#1a202c',
              'surface-light': '#ffffff',
              'surface-dark': '#2d3748',
              'primary-light': '#4299e1',
              'primary-dark': '#63b3ed',
              'text-light': '#2d3748',
              'text-dark': '#e2e8f0',
              'text-muted-light': '#718096',
              'text-muted-dark': '#a0aec0',
            }
          }
        }
      }
    </script>
    <style>
        /* Custom styles for toggle switch and panel transitions */
        .settings-panel {
            transition: transform 0.3s ease-in-out;
        }
        .settings-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .toggle-dot {
            transition: transform 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        /* Style for open accordion icon */
        .accordion-button[aria-expanded="true"] .accordion-icon {
            transform: rotate(180deg);
        }
    </style>
  </head>
  <body class="bg-bkg-light dark:bg-bkg-dark text-text-light dark:text-text-dark font-sans">
    
    <div id="root" class="w-full max-w-lg mx-auto p-4">
        <header class="flex justify-between items-center mb-6">
          <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
            <!-- Icons will be injected by JS -->
          </button>
          <h1 class="text-xl font-bold text-center">Block Mixture Calculator</h1>
          <button id="open-settings-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </header>

        <main>
          <!-- Patient Data Controls -->
          <div class="p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow-md mb-6">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <!-- Weight Control -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-center text-text-muted-light dark:text-text-muted-dark">Weight</label>
                    <div class="flex items-center justify-center mt-1">
                        <button data-control="weight" data-delta="-10" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded-l-md">-10</button>
                        <button data-control="weight" data-delta="-1" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 border-l border-r border-slate-300 dark:border-slate-600">-1</button>
                        <span id="weight-value" class="px-4 py-1 text-lg font-semibold bg-surface-light dark:bg-surface-dark w-24 text-center">70kg</span>
                        <button data-control="weight" data-delta="1" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 border-l border-r border-slate-300 dark:border-slate-600">+1</button>
                        <button data-control="weight" data-delta="10" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded-r-md">+10</button>
                    </div>
                </div>
                <!-- Height Control -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-center text-text-muted-light dark:text-text-muted-dark">Height</label>
                    <div class="flex items-center justify-center mt-1">
                        <button data-control="height" data-delta="-10" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded-l-md">-10</button>
                        <button data-control="height" data-delta="-1" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 border-l border-r border-slate-300 dark:border-slate-600">-1</button>
                        <span id="height-value" class="px-4 py-1 text-lg font-semibold bg-surface-light dark:bg-surface-dark w-24 text-center">170cm</span>
                        <button data-control="height" data-delta="1" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 border-l border-r border-slate-300 dark:border-slate-600">+1</button>
                        <button data-control="height" data-delta="10" class="control-btn px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded-r-md">+10</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-center gap-4">
                <button id="gender-male-btn" class="gender-btn px-6 py-2 rounded-md">Male</button>
                <button id="gender-female-btn" class="gender-btn px-6 py-2 rounded-md">Female</button>
            </div>
          </div>
          
          <!-- BMI & Ideal Weight -->
          <div class="p-4 bg-surface-light dark:bg-surface-dark rounded-lg shadow-md mb-6 flex justify-between items-center">
            <div class="text-center">
              <span class="text-sm text-text-muted-light dark:text-text-muted-dark">BMI</span>
              <p id="bmi-value" class="text-2xl font-bold">N/A</p>
            </div>
            <div class="text-right">
              <label class="flex items-center justify-end cursor-pointer">
                  <div class="mr-3 text-right">
                      <span class="text-sm text-text-muted-light dark:text-text-muted-dark">Ideal Weight</span>
                      <p id="ideal-weight-value" class="font-semibold">0 kg</p>
                  </div>
                  <div class="relative">
                      <input type="checkbox" id="ideal-weight-toggle" class="sr-only" />
                      <div class="block bg-slate-200 dark:bg-slate-700 w-10 h-6 rounded-full"></div>
                      <div id="ideal-weight-toggle-dot" class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div>
                  </div>
              </label>
            </div>
          </div>
          
          <!-- Selection Accordions -->
          <div class="space-y-2">
             <div class="border border-slate-200 dark:border-slate-700 rounded-lg">
                <button class="accordion-button w-full flex justify-between items-center p-4 bg-slate-100 dark:bg-slate-700/50 rounded-t-lg focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark" aria-expanded="false">
                    <h3 class="text-lg font-semibold">Facet levels</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="accordion-icon w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                <div class="accordion-content hidden p-4 bg-surface-light dark:bg-surface-dark rounded-b-lg">
                    <div id="facets-container" class="grid grid-cols-2 gap-2"></div>
                </div>
             </div>
             <div class="border border-slate-200 dark:border-slate-700 rounded-lg">
                <button class="accordion-button w-full flex justify-between items-center p-4 bg-slate-100 dark:bg-slate-700/50 rounded-t-lg" aria-expanded="false">
                    <h3 class="text-lg font-semibold">Dorsal roots</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="accordion-icon w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                <div class="accordion-content hidden p-4 bg-surface-light dark:bg-surface-dark rounded-b-lg">
                    <div id="dorsal-roots-container" class="grid grid-cols-2 gap-6"></div>
                </div>
             </div>
             <div class="border border-slate-200 dark:border-slate-700 rounded-lg">
                <button class="accordion-button w-full flex justify-between items-center p-4 bg-slate-100 dark:bg-slate-700/50 rounded-t-lg" aria-expanded="false">
                    <h3 class="text-lg font-semibold">Extra</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="accordion-icon w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                <div class="accordion-content hidden p-4 bg-surface-light dark:bg-surface-dark rounded-b-lg">
                    <div id="extra-container" class="grid grid-cols-2 gap-6"></div>
                </div>
             </div>
          </div>

          <!-- Suggested Mixture -->
          <div class="mt-6 p-4 bg-blue-100 dark:bg-blue-900/40 border border-blue-200 dark:border-blue-800 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-3 text-blue-800 dark:text-blue-200">Suggested Mixture</h2>
            <div class="space-y-2 text-blue-700 dark:text-blue-300">
                <div class="flex justify-between">
                    <span>Max Lignocaine for <span id="display-calc-weight">70.0</span>kg:</span>
                    <span id="max-lignocaine" class="font-semibold">315.0 mg</span>
                </div>
                <div class="flex justify-between">
                    <span>Lignocaine 2% allowed:</span>
                    <span id="lignocaine-allowed" class="font-semibold">15.8 ml</span>
                </div>
                <hr class="border-blue-200 dark:border-blue-700 my-2" />
                <div class="flex justify-between">
                    <span>Lignocaine ampules (2%):</span>
                    <span id="lignocaine-ampules" class="font-semibold">0.0 (5ml)</span>
                </div>
                <div class="flex justify-between">
                    <span>Dexa ampules:</span>
                    <span id="dexa-ampules" class="font-semibold">0 (1ml)</span>
                </div>
                <div class="flex justify-between">
                    <span>Saline ml:</span>
                    <span id="saline-ml" class="font-semibold">0.0 ml</span>
                </div>
                <hr class="border-blue-200 dark:border-blue-700 my-2" />
                <div class="flex justify-between text-lg">
                    <span class="font-bold">Total volume needed:</span>
                    <span id="total-volume" class="font-bold text-blue-800 dark:text-blue-200">0.0 ml</span>
                </div>
            </div>
          </div>
        </main>
    </div>

    <!-- Settings Panel -->
    <div id="settings-overlay" class="settings-overlay fixed inset-0 bg-black/60 z-40 opacity-0 pointer-events-none"></div>
    <div id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-full max-w-sm bg-surface-light dark:bg-surface-dark z-50 shadow-2xl p-6 transform translate-x-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">Settings</h2>
          <button id="close-settings-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="overflow-y-auto h-[calc(100vh-80px)] pr-2">
            <!-- Inputs will be injected by JS -->
            <div id="settings-inputs-container"></div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- STATE MANAGEMENT ---
        const state = {
            theme: 'dark',
            isSettingsOpen: false,
            weight: 70,
            height: 170,
            gender: 'male',
            useIdealWeight: false,
            selections: {
                facets: {},
                dorsalRoots: { left: {}, right: {} },
                extra: { left: {}, right: {} }
            },
            settings: {
                maxLignocaineDose: 4.5,
                maxDexamethasoneAmpules: 3,
                cVolume: 2,
                lVolume: 3,
                sVolume: 3,
                gonsVolume: 4,
                shoulderVolume: 4,
                hipVolume: 4,
                kneeVolume: 4,
                ankleVolume: 4,
            }
        };

        // --- CONSTANTS ---
        const FACET_LEVELS = ["C3-C7", "L1-S1", "S2-S4", "GONS"];
        const DORSAL_ROOTS_C = ["C3", "C4", "C5", "C6", "C7"];
        const DORSAL_ROOTS_L = ["L1", "L2", "L3", "L4", "L5"];
        const DORSAL_ROOTS_S = ["S1", "S2", "S3", "S4"];
        const ALL_DORSAL_ROOTS = [...DORSAL_ROOTS_C, ...DORSAL_ROOTS_L, ...DORSAL_ROOTS_S];
        const EXTRA_ITEMS = ["Shoulder", "Hip", "Knee", "Ankle"];

        const SETTINGS_CONFIG = {
            maxLignocaineDose: { label: 'Max Lignocaine dose (mg/kg)', step: 0.1, min: 0 },
            maxDexamethasoneAmpules: { label: 'Max Dexamethasone ampules', step: 1, min: 0 },
            cVolume: { label: 'C volume (ml)', step: 0.1, min: 0 },
            lVolume: { label: 'L volume (ml)', step: 0.1, min: 0 },
            sVolume: { label: 'S volume (ml)', step: 0.1, min: 0 },
            gonsVolume: { label: 'GONS volume (ml)', step: 0.1, min: 0 },
            shoulderVolume: { label: 'Shoulder volume (ml)', step: 0.1, min: 0 },
            hipVolume: { label: 'Hip volume (ml)', step: 0.1, min: 0 },
            kneeVolume: { label: 'Knee volume (ml)', step: 0.1, min: 0 },
            ankleVolume: { label: 'Ankle volume (ml)', step: 0.1, min: 0 },
        };

        // --- DOM ELEMENT REFERENCES ---
        const dom = {
            html: document.documentElement,
            themeToggle: document.getElementById('theme-toggle'),
            openSettingsBtn: document.getElementById('open-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsOverlay: document.getElementById('settings-overlay'),
            settingsInputsContainer: document.getElementById('settings-inputs-container'),
            weightValue: document.getElementById('weight-value'),
            heightValue: document.getElementById('height-value'),
            genderMaleBtn: document.getElementById('gender-male-btn'),
            genderFemaleBtn: document.getElementById('gender-female-btn'),
            bmiValue: document.getElementById('bmi-value'),
            idealWeightValue: document.getElementById('ideal-weight-value'),
            idealWeightToggle: document.getElementById('ideal-weight-toggle'),
            idealWeightToggleDot: document.getElementById('ideal-weight-toggle-dot'),
            facetsContainer: document.getElementById('facets-container'),
            dorsalRootsContainer: document.getElementById('dorsal-roots-container'),
            extraContainer: document.getElementById('extra-container'),
            displayCalcWeight: document.getElementById('display-calc-weight'),
            maxLignocaine: document.getElementById('max-lignocaine'),
            lignocaineAllowed: document.getElementById('lignocaine-allowed'),
            totalVolume: document.getElementById('total-volume'),
            lignocaineAmpules: document.getElementById('lignocaine-ampules'),
            dexaAmpules: document.getElementById('dexa-ampules'),
            salineMl: document.getElementById('saline-ml'),
        };

        const ICONS = {
            sun: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-slate-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`
        };

        // --- CALCULATION LOGIC ---
        const calculations = {
            bmi: () => {
                if (state.height <= 0) return 'N/A';
                const heightInMeters = state.height / 100;
                return (state.weight / (heightInMeters * heightInMeters)).toFixed(1);
            },
            idealWeight: () => {
                const heightInInches = state.height / 2.54;
                if (heightInInches <= 60) {
                    return state.gender === 'male' ? 50 : 45.5;
                }
                const inchesOver5Ft = heightInInches - 60;
                const baseWeight = state.gender === 'male' ? 50 : 45.5;
                return (baseWeight + (2.3 * inchesOver5Ft));
            },
            totalVolumeNeeded: () => {
                let total = 0;
                const s = state.selections;
                const v = state.settings;

                if (s.facets['C3-C7']) total += 10 * v.cVolume;
                if (s.facets['L1-S1']) total += 12 * v.lVolume;
                if (s.facets['S2-S4']) total += 6 * v.sVolume;
                if (s.facets['GONS']) total += v.gonsVolume;

                ['left', 'right'].forEach(side => {
                    DORSAL_ROOTS_C.forEach(r => { if(s.dorsalRoots[side][r]) total += v.cVolume });
                    DORSAL_ROOTS_L.forEach(r => { if(s.dorsalRoots[side][r]) total += v.lVolume });
                    DORSAL_ROOTS_S.forEach(r => { if(s.dorsalRoots[side][r]) total += v.sVolume });
                    
                    if (s.extra[side]['Shoulder']) total += v.shoulderVolume;
                    if (s.extra[side]['Hip']) total += v.hipVolume;
                    if (s.extra[side]['Knee']) total += v.kneeVolume;
                    if (s.extra[side]['Ankle']) total += v.ankleVolume;
                });
                return total;
            }
        };
        
        // --- UI UPDATE FUNCTIONS ---
        function updateUI() {
            // Theme
            dom.html.classList.toggle('dark', state.theme === 'dark');
            dom.html.classList.toggle('light', state.theme === 'light');
            dom.themeToggle.innerHTML = state.theme === 'dark' ? ICONS.sun : ICONS.moon;
            
            // Settings Panel
            dom.settingsPanel.classList.toggle('translate-x-full', !state.isSettingsOpen);
            dom.settingsOverlay.classList.toggle('opacity-0', !state.isSettingsOpen);
            dom.settingsOverlay.classList.toggle('pointer-events-none', !state.isSettingsOpen);

            // Patient Data
            dom.weightValue.textContent = `${state.weight}kg`;
            dom.heightValue.textContent = `${state.height}cm`;
            dom.genderMaleBtn.classList.toggle('bg-primary-light', state.gender === 'male');
            dom.genderMaleBtn.classList.toggle('dark:bg-primary-dark', state.gender === 'male');
            dom.genderMaleBtn.classList.toggle('text-white', state.gender === 'male');
            dom.genderMaleBtn.classList.toggle('bg-slate-200', state.gender !== 'male');
            dom.genderMaleBtn.classList.toggle('dark:bg-slate-700', state.gender !== 'male');
            dom.genderFemaleBtn.classList.toggle('bg-primary-light', state.gender === 'female');
            dom.genderFemaleBtn.classList.toggle('dark:bg-primary-dark', state.gender === 'female');
            dom.genderFemaleBtn.classList.toggle('text-white', state.gender === 'female');
            dom.genderFemaleBtn.classList.toggle('bg-slate-200', state.gender !== 'female');
            dom.genderFemaleBtn.classList.toggle('dark:bg-slate-700', state.gender !== 'female');

            // BMI and Ideal Weight
            const idealWeight = calculations.idealWeight();
            dom.bmiValue.textContent = calculations.bmi();
            dom.idealWeightValue.textContent = `${idealWeight.toFixed(1)} kg`;
            dom.idealWeightToggle.checked = state.useIdealWeight;
            dom.idealWeightToggleDot.classList.toggle('translate-x-4', state.useIdealWeight);
            dom.idealWeightToggleDot.classList.toggle('bg-primary-dark', state.useIdealWeight);

            // Update selection buttons
            document.querySelectorAll('[data-selection-key]').forEach(btn => {
                const { category, item, side } = btn.dataset;
                let isSelected;
                if (side) {
                    isSelected = state.selections[category][side][item];
                } else if (category === 'facets') {
                    isSelected = state.selections[category][item];
                }
                btn.classList.toggle('bg-primary-light', isSelected);
                btn.classList.toggle('dark:bg-primary-dark', isSelected);
                btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('bg-slate-200', !isSelected);
                btn.classList.toggle('dark:bg-slate-700', !isSelected);
            });

            // Mixture Calculations
            const calculationWeight = state.useIdealWeight ? idealWeight : state.weight;
            const maxLignocaine = calculationWeight * state.settings.maxLignocaineDose;
            const lignocaineAllowed = maxLignocaine / 20;
            const totalVolumeNeeded = calculations.totalVolumeNeeded();

            let lignocaineAmpules = 0, dexaAmpules = 0, salineMl = 0;
            if (totalVolumeNeeded > 0 && !isNaN(lignocaineAllowed)) {
                const lignocaineVolumeToUse = Math.min(totalVolumeNeeded, lignocaineAllowed);
                const theoreticalLignocaineAmpules = lignocaineVolumeToUse / 5;
                const roundedLignocaineAmpules = Math.floor(theoreticalLignocaineAmpules * 2) / 2;
                const actualLignocaineVolume = roundedLignocaineAmpules * 5;

                const dexaAmpulesRaw = Math.floor(roundedLignocaineAmpules);
                const maxDexa = state.settings.maxDexamethasoneAmpules;
                const finalDexaAmpules = Math.min(dexaAmpulesRaw, maxDexa);
                
                const salineMlRaw = totalVolumeNeeded - actualLignocaineVolume - finalDexaAmpules;

                lignocaineAmpules = roundedLignocaineAmpules;
                dexaAmpules = finalDexaAmpules;
                salineMl = Math.max(0, salineMlRaw);
            }
            
            dom.displayCalcWeight.textContent = calculationWeight.toFixed(1);
            dom.maxLignocaine.textContent = `${maxLignocaine.toFixed(1)} mg`;
            dom.lignocaineAllowed.textContent = `${lignocaineAllowed.toFixed(1)} ml`;
            dom.totalVolume.textContent = `${totalVolumeNeeded.toFixed(1)} ml`;
            dom.lignocaineAmpules.textContent = `${lignocaineAmpules.toFixed(1)} (5ml)`;
            dom.dexaAmpules.textContent = `${dexaAmpules} (1ml)`;
            dom.salineMl.textContent = `${salineMl.toFixed(1)} ml`;
        }

        // --- DYNAMIC CONTENT RENDERERS ---
        function renderSelectionButtons() {
            // Facets
            dom.facetsContainer.innerHTML = FACET_LEVELS.map(item => `
                <button data-selection-key="${item}" data-category="facets" data-item="${item}" class="selection-btn p-3 rounded-md transition-colors">
                    ${item}
                </button>
            `).join('');

            // Dorsal Roots & Extra (helper function)
            const createGrid = (title, items, category, side) => `
                <div>
                    <h4 class="font-semibold mb-2">${title}</h4>
                    <div class="grid grid-cols-3 gap-2">
                    ${items.map(item => `
                        <button data-selection-key="${side}-${item}" data-category="${category}" data-item="${item}" data-side="${side}" class="selection-btn p-2 rounded-md text-sm transition-colors">
                            ${item}
                        </button>
                    `).join('')}
                    </div>
                </div>
            `;
            dom.dorsalRootsContainer.innerHTML = createGrid('Left', ALL_DORSAL_ROOTS, 'dorsalRoots', 'left') + createGrid('Right', ALL_DORSAL_ROOTS, 'dorsalRoots', 'right');
            dom.extraContainer.innerHTML = createGrid('Left', EXTRA_ITEMS, 'extra', 'left') + createGrid('Right', EXTRA_ITEMS, 'extra', 'right');
        }

        function renderSettingsInputs() {
            dom.settingsInputsContainer.innerHTML = Object.keys(state.settings).map(key => {
                const config = SETTINGS_CONFIG[key];
                return `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-text-muted-light dark:text-text-muted-dark mb-1">${config.label}</label>
                    <input
                      type="number"
                      data-setting-key="${key}"
                      value="${state.settings[key]}"
                      step="${config.step || 0.1}"
                      min="${config.min || 0}"
                      class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-2 focus:ring-primary-light dark:focus:ring-primary-dark focus:border-primary-light dark:focus:border-primary-dark"
                    />
                </div>
                `;
            }).join('');
        }
        
        // --- EVENT HANDLERS ---
        function handleThemeToggle() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            updateUI();
        }

        function handleSettingsToggle(isOpen) {
            state.isSettingsOpen = isOpen;
            updateUI();
        }

        function handleNumericControl(control, delta) {
            const min = control === 'weight' ? 30 : 80;
            const max = control === 'weight' ? 200 : 270;
            state[control] = Math.max(min, Math.min(max, state[control] + delta));
            updateUI();
        }

        function handleSelectionToggle(category, item, side) {
             if (side) {
                state.selections[category][side][item] = !state.selections[category][side][item];
            } else {
                state.selections[category][item] = !state.selections[category][item];
            }
            updateUI();
        }

        // --- EVENT LISTENERS INITIALIZATION ---
        function initEventListeners() {
            dom.themeToggle.addEventListener('click', handleThemeToggle);
            dom.openSettingsBtn.addEventListener('click', () => handleSettingsToggle(true));
            dom.closeSettingsBtn.addEventListener('click', () => handleSettingsToggle(false));
            dom.settingsOverlay.addEventListener('click', () => handleSettingsToggle(false));

            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { control, delta } = btn.dataset;
                    handleNumericControl(control, parseInt(delta));
                });
            });

            dom.genderMaleBtn.addEventListener('click', () => { state.gender = 'male'; updateUI(); });
            dom.genderFemaleBtn.addEventListener('click', () => { state.gender = 'female'; updateUI(); });
            dom.idealWeightToggle.addEventListener('change', (e) => { state.useIdealWeight = e.target.checked; updateUI(); });

            document.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const isExpanded = button.getAttribute('aria-expanded') === 'true';
                    button.setAttribute('aria-expanded', !isExpanded);
                    content.classList.toggle('hidden');
                });
            });

            // Delegated event listener for selection buttons
            document.getElementById('root').addEventListener('click', (e) => {
                if (e.target.matches('.selection-btn')) {
                    const { category, item, side } = e.target.dataset;
                    handleSelectionToggle(category, item, side);
                }
            });

            // Delegated event listener for settings inputs
            dom.settingsInputsContainer.addEventListener('input', (e) => {
                if(e.target.matches('input[data-setting-key]')) {
                    const key = e.target.dataset.settingKey;
                    state.settings[key] = parseFloat(e.target.value);
                    // No need to call updateUI() here, as it re-renders inputs and loses focus.
                    // The main UI will get the new values on the next regular update.
                    // We can manually trigger a calculation update if needed.
                    updateUI(); // Simple enough app that re-render is fine.
                }
            });
        }
        
        // --- INITIALIZATION ---
        function initializeState() {
            FACET_LEVELS.forEach(f => state.selections.facets[f] = false);
            ALL_DORSAL_ROOTS.forEach(dr => {
                state.selections.dorsalRoots.left[dr] = false;
                state.selections.dorsalRoots.right[dr] = false;
            });
            EXTRA_ITEMS.forEach(e => {
                state.selections.extra.left[e] = false;
                state.selections.extra.right[e] = false;
            });
        }
        
        // --- APP START ---
        initializeState();
        renderSelectionButtons();
        renderSettingsInputs();
        initEventListeners();
        updateUI(); // Initial render
    });
    </script>

  </body>
</html>
